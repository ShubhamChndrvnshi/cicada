// 0x0c60b45022dbf08f22cdba94aed1051cf482a50c63f922b32fd78ed0b1edb3e4
// 0x0c60b45022dbf08f22cdba94aed1051cf482a50c63f922b32fd78ed0b1edb3e4
// 0x0c60b45022dbf08f22cdba94aed1051cf482a50c63f922b32fd78ed0b1edb3e4
// 0x0c60b45022dbf08f22cdba94aed1051cf482a50c63f922b32fd78ed0b1edb3e4
// 0x0c60b45022dbf08f22cdba94aed1051cf482a50c63f922b32fd78ed0b1edb3e4
// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8;

import 'forge-std/Test.sol';
import '../src/CicadaVote.sol';
import '../src/LibUint1024.sol';


contract VoteWrapper is CicadaVote {
    function createVote(
        CicadaVote.PublicParameters memory pp,
        string memory description,
        uint64 startTime,
        uint64 votingPeriod
    )
        external
    {
        _createVote(pp, description, startTime, votingPeriod);
    }

    function castBallot(
        uint256 voteId,
        CicadaVote.PublicParameters memory pp,
        CicadaVote.Puzzle memory ballot,
        CicadaVote.ProofOfValidity memory PoV
    )
        external
    {
        _castBallot(voteId, pp, ballot, PoV);
    }

    function finalizeVote(
        uint256 voteId,
        CicadaVote.PublicParameters memory pp,
        uint64 tallyPlaintext,
        uint256[4] memory w,
        CicadaVote.ProofOfExponentiation memory PoE
    )
        external
    {
        _finalizeVote(voteId, pp, tallyPlaintext, w, PoE);
    }
}

contract EndToEndTest is Test {
    using LibUint1024 for *;

    VoteWrapper vote;

    function setUp() external {
        vote = new VoteWrapper();
        vote.createVote(_getPublicParameters(), "test", 0, 5 days);
    }

    function testEndToEnd()
        external
    {
        CicadaVote.PublicParameters memory pp = _getPublicParameters();
        CicadaVote.Puzzle memory Z;
        CicadaVote.ProofOfValidity memory PoV;

        Z.u = [
            23489379554212787716297286336400230924823639494927389162645093122068697658603,
            37994115889062897136909463284827961322528577721468711470111792745670765942867,
            97077108053781541281866133034371836742186684180744136796867385421792889504143,
            52481946849260776796677582433224170986876971764060833656580302092021184213269
        ];
        Z.v = [
            35600663432346380153446910004417433253592338133281874152893025468217324431681,
            41936256534076298449675261669218207700254873127224508916666198171169558014661,
            49606555105801504697610118424240522760910190301595471979563133094766014042174,
            97187797365675396536066258551623759296263944853284530472532058098286260654169
        ];

        PoV.a_0 = [
            2193483396949805038425851590208874152768590326965025675316790545793764500773,
            58958698746942983107351083311302048204952231825308714340391719975605305661553,
            62098843209019796024625068526880242428944385365049179694190435939749619831588,
            76609833343722458788144017129103406834998508197826002881630501715784593790910
        ];
        PoV.b_0 = [
            19685478523020230807073908293739264789244589629545717254608978506140682034213,
            54293479508762189229615466687359018182182635873502176363398186242493454022651,
            97102943672666035284169056228918035512064319181097512995455388512836060659399,
            44289775197537985498624778848304205103081806799668272520216001408752145267064
        ];
        PoV.t_0 = [
            0,
            0,
            727958170241811930667477020283811284384346663985281018563729721523367820325,
            12638582677393472115993597249466965963540208153497137822043475807718172816583
        ];
        PoV.c_0 = 53372033020874779294388244492557677385791990277660617138412758930614110379407;

        PoV.a_1 = [
            36000538370202491806844386513337837548832578705627853840377101379265010081044,
            87774900126947956621861529202658552280319395356002967636979492238885224171063,
            1974138230668677728401088247510607668264243638444760272007446290155265929716,
            70844788575054650733025761312545289906172720849034070478830559556588309953206
        ];
        PoV.b_1 = [
            972659026072011872363847601577128228723992530559524243300941843680643513198,
            9644691788383087792711259934376642006731598929542626393625307332412595298275,
            114349266997976375878297392385987841634750164105935438655512280570236573229770,
            60390765691475151322398355872853807157332504974418084970527004998943210519070
        ];
        PoV.t_1 = [
            0,
            0,
            1412886910623925686113043774577136422368541902681915227729149969772159316435,
            70550072162344199767685676881989067687017940290381357150446492225201196034518
        ];
        PoV.c_1 = 103589258189839117015035025291952831871436523652326916957236289218537932037155;

        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            20929137808607051891649195737620531732393579546665847047171828178907778053116,
            27628372636339723313090742617092950234499931252502278475800002307095250234187,
            65962529147856913974628783868244351137634308867122853676566109514984346262744,
            75245502987622199507484338310097723676076580604530859524652355715328803269940
        ];
        Z.v = [
            10550564679903784793343722175065225776780937187484254864137286882090954125243,
            50984463950726179171690557947450947853315767359067463280110059564571660963080,
            6143922507896872706266720155747027559564740815149766307873084995138313146246,
            57085347755743306222180810363709420585068702184055377037712910122653208348762
        ];

        PoV.a_0 = [
            48767296643967885995355139762821068617450087612236196765010959926641648524507,
            48067063527074493483914802278916593905963901580530501170181296560920090792011,
            5667016520284954159680321578697525986549449832219432556248434642642017384484,
            16794504608474068641374930494144469266283076389680430914092583208613721284789
        ];
        PoV.b_0 = [
            36079705880737317942048240459585823086569650657253880741328045732147334291127,
            57966011496240856955486431117344224262501726641109143056342318196700236485463,
            64609543327697603452542969572801262809451369203359755849845972149767036440813,
            103032974034954664402581909228147705227133187183266626804896694947400367912508
        ];
        PoV.t_0 = [
            0,
            0,
            624775522484889133970728541510299802698524379024714498606968929969382510832,
            78032359061455185838562891103220690556861684129297302770443422505668668671787
        ];
        PoV.c_0 = 68228502913080185752350400657771757325976121102736373582422694374180751890188;

        PoV.a_1 = [
            39058093161997093494371170351029433675062367183002092385670926933903561755840,
            92721999967109296751582154195701344009195715977459139000592666190861709446669,
            42677358387928710377998396258025932131296702986664656995050382309645737056395,
            103569754937811957966281317798087730434602041951691625780370466766359237797254
        ];
        PoV.b_1 = [
            41074146683790806905837130762743617867430541229196834833432149781395143199328,
            57899370341927124643181253752919233581366798366541419432300177955256937523885,
            115696517908265186499492027822484774135282777254106473210432641461335881515315,
            30608150319134664311509686853453903225166030759376981296657281519106692179083
        ];
        PoV.t_1 = [
            0,
            0,
            849806935631835897276933635362629776188679568149791501610908268800303209069,
            85732671353582352954689659413261747997558141871169344844137362251375193005725
        ];
        PoV.c_1 = 92803019479231911515621205381132057024867292098903094829261757276640752500281;

        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            2812085602224827136522632037260270899672827702409214416632433117167417266564,
            92999556366763132090480610650259304640537594560134158454697522716640909785938,
            22629381671726203309262289124161440255554870522437589367080810795412671981649,
            4965590949235826137950846835065392614098701376613291657535054937016842999674
        ];
        Z.v = [
            3170493867685624164943799895803839005394324890882326364345143283819920163045,
            35573478928730554104151719298520444060287441404752735264301769954966995901482,
            108511899957458003275163397671534545865079878649726431428968428419365224234783,
            40897442149981135153817634160740454519418339736425011640807602204974851196872
        ];

        PoV.a_0 = [
            1938052837221658867897697087703392647552045047907517604489742735093198270617,
            8174263377689893321881350265797761560069573291866959184751556726064964003471,
            55977519653490528340245347200064456520027966925476002103774860316946548316148,
            38934773518029021626091582752550135860195100472569130970799616449690571562072
        ];
        PoV.b_0 = [
            20217132391171037982579262458876561928782314614483602730700033461119602339783,
            53117229643211696986324029567163151404663074644306272997520553148637118807227,
            48681719761214378700663226325975063285387093180942188619298588664348764034595,
            87002368174621584620623763525178847370033813256738518667318872071652339833161
        ];
        PoV.t_0 = [
            0,
            0,
            2267807289192228435636458252057130678291049025338578364708287950765502585686,
            9042501014324351209867700127129423216367719413022921941772860895454473690548
        ];
        PoV.c_0 = 105088555998671059028038905061616315666443153574689288746592412915539672828443;

        PoV.a_1 = [
            5750567996416044917733825390912540460515479926598738580823580328735315819447,
            79964036295188264682542693713271461995922453814684974101486633090702421817146,
            113812103502452032500775268945832638239712033329358210426126562388160972017778,
            78347048299953764560786556447909167081280414494480908483114069151698351107774
        ];
        PoV.b_1 = [
            2071462628335847964012541505327160692950056227218125743409548353280756989502,
            106575458345631543606515764362260241804702971482143152727413587987758424511721,
            97564116217715736077366736361964491248404089750803886677103003140471433679599,
            46328266961926493658943534153006477150691409670989701747173171982238654083307
        ];
        PoV.t_1 = [
            0,
            0,
            1683268640781003376283691341978535791602306244712722199676192819231237860363,
            95688343535368461208277609942943157038235948072022643884458226614012208389860
        ];
        PoV.c_1 = 78001456146888367501293660512950725029614120919861734251071400614848585567120;

        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            9161648506583218024562121955573063405558166505609005715410362096577840483029,
            56094689495683226901104772511040351620296627170054595222078729126786465411133,
            47852946655391015756122919100799232469343283610406207377752686970268869144499,
            53098407511897425087789578467445259361723959583814215620485436990876712220953
        ];
        Z.v = [
            28288972407091507926472994357267520983014662925210333251328940799130224570543,
            43093768033347262992238892077921054387753293649643216314472021361785305740291,
            75239640302675568243871027776539302428225348047638725393592830831928385980094,
            103305711259632763813955885279792131964460025003969679060624401917301748719120
        ];

        PoV.a_0 = [
            34960601055471278903335110387656534524730693759847430490601250017546050031379,
            99042873845588984523840454150533446767291885153972186368952441661880398215685,
            25319084325102309639961014888310728804601833664541789795204611690458762350637,
            62440371432344219381919064263309177134182599276515740928226168728490100868283
        ];
        PoV.b_0 = [
            31749140932045896953311596082037657568895105797103411282507939937847058715986,
            21422059192304163100427850867446183604019001841403179685551719486171307812045,
            863349015809280185849725287207660108307075470748996476477568640279132183447,
            25842062457005750427662752107894222497732248725833312080310209607977798698843
        ];
        PoV.t_0 = [
            0,
            0,
            14035738713119304789367618512249589613883713037359797685901720983325268702240,
            15986100620448397056742445519462225043637491768055940564010187415390210690050
        ];
        PoV.c_0 = 79607025702070575517391185298092643522502238916921591421505275768800528807213;

        PoV.a_1 = [
            47467386503482035061625514774397508690969204623982841868268756756698423481785,
            2553987071075735568230122365107710779130869759121448415705203931615402055309,
            57692854062817396132047864904573454821340978630349662653730085801748166641069,
            59485107828576060589997102029864754872804420394936263991822957611139324896654
        ];
        PoV.b_1 = [
            16110681774279445654344187719551382733034358629162575811211288904582968840964,
            86362683277900926354459277249698186406538009793136396643908915234502157110271,
            15793852720703635963227898228926490396945367076236122429233210726299265863566,
            30554132555889115005086384300022604402808292618238104880942356055404349433399
        ];
        PoV.t_1 = [
            0,
            0,
            19298550181142848811774594079980756079064718181390371759475991164109153268721,
            20932800858863949192819795847308195903315574354735308155866307388484730001858
        ];
        PoV.c_1 = 109456310899186718434004674292008261722217956757495330224706523905441044898378;

        vote.castBallot(1, pp, Z, PoV);

        Z.u = [
            39254138832870529389252953419948822457364408125974319918574544003618753318237,
            104492449361405712175753864711354643458497873727960141967867116786624038287985,
            62727850404202608996613259120920650620097093460714459070000692780930781766023,
            71363077428592487183223371222728894555880830140531382670902554837759538506497
        ];
        Z.v = [
            45623050585151563544952462387755097250218188858584581407406209320679370447986,
            8148335469517582746575207949160267955965926595696914290668598171896461985672,
            47457108464381911519831829491609315557739303068054402845368172165471889005177,
            110407506612848094475833036052237635576932020577654529086827143383243748470045
        ];

        PoV.a_0 = [
            6385128284946988043367958429659046075085099563949824056616420993725629882590,
            85954752786059210562087082128243764897654741283721003632805743999231918213335,
            112382202172110664164556147144467461509434042947730671993165636719746532417354,
            24476780311343187237534748602931845760787050731502578439277169544998082045076
        ];
        PoV.b_0 = [
            18880534886620297678762132971108163457477959540629703311239414011445366946770,
            66894601521093921928771295665925233727816135890414093403723108915651050908887,
            52111660814560497891067561589455625658629282324463944063325054999702105552820,
            25631277220061510361298049785350522140780515439448968493012437225963441561648
        ];
        PoV.t_0 = [
            0,
            0,
            4186533977270135546069813155193089386808710331929850691169840125085054981258,
            51338177631424065582299562738596633309492619401249732030314831717695046473796
        ];
        PoV.c_0 = 41194201606286428459826543283745174443106278973115323295215854616920384362529;

        PoV.a_1 = [
            20117303779936784570972087792433281891590069670996969091397232301916208528569,
            88793401153013508600100312451069345517927663870677328154781672942181149026517,
            87494859647138994085641799619846612260635586814261338720428316688854544715984,
            103481822148164315958266354793323282193724393944658382240993236670565640366620
        ];
        PoV.b_1 = [
            2407214633164872851554260336265398806271695903280044078509258954935917447295,
            49641221145056795648947247193907508962355776788741792074261399176766835643819,
            12624057690577438768038811290617938088263740768421914661592680903834429507781,
            78252319476667114700532201780604130929167740032411183386305036294778660058615
        ];
        PoV.t_1 = [
            0,
            0,
            9401699607101178520490064979424809982249736262763552517208106002708587684956,
            12656037309962672007243838760747372673835951092557946459430689498748386696496
        ];
        PoV.c_1 = 92509821049919944439361115551255298163012138754461066626352011557074686479861;

        vote.castBallot(1, pp, Z, PoV);


        uint64 s = 1;
        uint256[4] memory w = [
            28414932443764738830564903359950797865484211190424064538004503975237359384768,
            78302427971063926143211242979677133071782284323374178975290753191645310311131,
            63591546634036360122446433588244038044791907861575487040527793875402069471943,
            8584656246743806573532170138078769091895145567737263954762759411783033287163
        ];
        
        CicadaVote.ProofOfExponentiation memory PoE;
        PoE.pi = [
            29789496849499463416377936461948604359175868948748463489297460303044412671537,            
            84241454685576362319579082542927384771384188715405880289985202927565478078711,            
            89127256518158598782564459199195857142624384050872902756984630239507441803082,            
            13082702427294132855110070216356954899420740592650057963959250488739726774009            
        ];
        PoE.j = 217;
        PoE.l = 87614331585164606345780156150023272162264970240141614821500640640477967349243;
        
        vm.warp(block.timestamp + 5 days);
        vote.finalizeVote(1, pp, s, w, PoE);
    }

    function _getPublicParameters()
        private
        pure
        returns (CicadaVote.PublicParameters memory pp)
    {
        pp.N = [
            104147290953081953116519342189680461202283970177095637651360327564142873057416,
            15323782261878761100940034441204785377633939724683272673612692230846374627270,
            30626622612874280430956281005231024907843388292234071834599539592358783218071,
            75550948985734109904230386121272605944376216870656806194411477059193981943725
        ];
        pp.T = 40021;
        pp.g = [
            38338619972585583524483588294576085526263719585032736518191750574776396851770,
            94637755088308739015539331713451552304119396745550668265478378511704452789700,
            81979518852796522894246525026364630442212411519037886131695781789361026592468,
            33068834608903278684910599753425603154142727787471906994280590175407940221533
        ];
        pp.h = [
            10627060509790627577208293000319937757807187998048284132448433575372480544950,
            57139964514252520354604615248090205817278464251575330913786979684458387538116,
            75494762157673401388298765995686858423379866692937237014406921769184891643995,
            56060671937879155849178436884500994013882268730731096865621282739255033126228
        ];
        pp.y = [
            34191636981016140802634534452322680877255965106630875449526046633990680066648,
            34441617949927569315321988972654156222616592457356755264799133474559668395341,
            57877948910658844627563603235227267284022018920412795216919468793542807888704,
            2254839433241126598069736158127149973342154671916593168312857308735609262013
        ];
        pp.yInv = [
            44358156422166923400525853689838101737767839495582486400211309773037923636407,
            71690686957939592564771969169560335282590550293627571793522826825123829928477,
            21685073366951704119758578478762824383476538405831323642172105655178584492926,
            63965590386543262870395486045541999774929531603101993038740780729523982669208
        ];
    }
}
