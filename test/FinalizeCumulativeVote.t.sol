// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8;

import 'forge-std/Test.sol';
import '../src/CicadaCumulativeVote.sol';
import '../src/LibUint1024.sol';
import '../src/LibSigmaProtocol.sol';


contract VoteWrapper is CicadaCumulativeVote {  
    function createVote(PublicParameters calldata pp)
        external
    {
        _createVote(
            pp,
            "test",
            10,
            0,
            0,
            6
        );

        Vote storage newVote = votes[1];
        newVote.tallies[0].u = [
            uint256(3596103936234939230202299155575730863034515001032962628933973319462596878483),
            uint256(27926176183472582677359717875001375129571787686988056889000751046151069824018),
            uint256(27966558459561629749077680962806336334506452912429435887182498036956925978989),
            uint256(71607954708365285738792164419133985632550570874734738219627878933366912651526)
        ];
        newVote.tallies[0].v = [
            uint256(1944159612984878121317696357910774728732097252123125888030919630682349483173),
            uint256(56617472276372967534282418242070199443153980635261191903598375011097546652098),
            uint256(24275758956990332107124967382284158286153901892084702046211439378542549885158),
            uint256(40102166767157099262590738636922518577467997568801767539611918626735712767592)
        ];
        newVote.tallies[1].u = [
            uint256(41309650145648117748097756237184654250509073057555731550118262821931898611957),
            uint256(35388564065028340806157158457475789595775871496857881956816639363372676975592),
            uint256(740847668348249895814670114568787044038451193518991253788088556433407455071),
            uint256(57761900506193539774086284563827841851908177279761632641469413494989755941094)
        ];
        newVote.tallies[1].v = [
            uint256(3134242020680757475798493641290023829727623278463709187764288674057260239337),
            uint256(79919573355472026332810057671495144011961459936413422665186952744176811254624),
            uint256(58661119976521184981797448805090856657940029253948394513517337393969240891307),
            uint256(32560094693959101348547641924884701650131439993586756607228394354397806119879)
        ];
        newVote.tallies[2].u = [
            uint256(544296280815435011740193325631672975875536235980456387442196136400427204552),
            uint256(103781236657139110011506793050097071177939669569910632547135433982581002677966),
            uint256(88746655246312595147450303810043233711114079573882325241512071057096506307609),
            uint256(85515898542895124056690899392345732411790350259256833326852679845280429405846)
        ];
        newVote.tallies[2].v = [
            uint256(25691415294997241338332193441562225690584111721688304241631408294008537819763),
            uint256(22757115471269728721306319754828194259496588923448143885153756166957177627635),
            uint256(2181482335109949892828797941747073480128106428722366399244862616676634547190),
            uint256(104206758140405710478404864438153798005408732941692668348265658751616864286330)
        ];
        newVote.tallies[3].u = [
            uint256(37468579944341119792027751219333244028387865273558246182212817379259121965187),
            uint256(75437973631740547323650267902411662914302204922780413868335961217373585748232),
            uint256(49325113271099439067980810426479343518375315238074778442519633823587111252969),
            uint256(96218020525601051728281376718524706003548450120792087497292118273320283194180)
        ];
        newVote.tallies[3].v = [
            uint256(17753913334159536521734514615017669302002577139944809521769112444616449314135),
            uint256(10360494637611060430486495015773805667037358199491757072120170683495917656849),
            uint256(42126204826632545723448690202652301070710235390373534347384505699424141576417),
            uint256(10182968710744235001999842371357512686372467311199021898931072789701161674960)
        ];
        newVote.tallies[4].u = [
            uint256(24067481807389398081885062008310542273170534592558966980126949446664242392854),
            uint256(113530417362784240930911623416536578361472274607216692811854879448964921224802),
            uint256(27811322666116647430898935176359295894957837895276270338203956419878138095583),
            uint256(16747865049083141125471894004351954774486651022397902286202869333923227808141)
        ];
        newVote.tallies[4].v = [
            uint256(25355359038051419004993274768751759271152005886644217543138054873225187254235),
            uint256(81232708960080467106147785805717402085932379931944812689530839856870718548588),
            uint256(9402182017008734288540264372155239267192095006356337657967112400332365536762),
            uint256(104398690269737734316842765132768095334830127136958587569549491567623359720010)
        ];
        newVote.tallies[5].u = [
            uint256(12067860547494873995989406526983374404509553761342560865908983909025469735224),
            uint256(20547665327447811625001445220803405120966666541409076753818467059908654302573),
            uint256(76789871249597963631750404165688818787650965475178376617468825978594383734656),
            uint256(115222455208598205956419489146738401671059331255500878025521585672112532848648)
        ];
        newVote.tallies[5].v = [
            uint256(25043706586663184760841548499792128324738570077234756748808888024102375695736),
            uint256(12324578134583767367576177739361664775874564938313371903766940887553965111276),
            uint256(66759236779360169140202754210291031920084979228768038679840667682128994971306),
            uint256(67848319164214598831736534543993880441722867788587875935980073916125150904328)
        ];
    }

    function finalizeVote(
        PublicParameters calldata pp,
        uint256[] calldata talliesPlaintext,
        uint256[4][] memory w,
        LibSigmaProtocol.ProofOfExponentiation[] calldata proofs
    )
        external
    {
        _finalizeVote(1, pp, talliesPlaintext, w, proofs);
    }
}


contract FinalizeCumulativeVoteGeneratedTest is Test {
    using LibUint1024 for *;

    VoteWrapper vote;

    function setUp() external {
        vote = new VoteWrapper();
        vote.createVote(_publicParameters());
    }

    function _publicParameters()
        private
        pure
        returns (CicadaCumulativeVote.PublicParameters memory pp)
    {
        pp.T = 17373;
        pp.N = [
            uint256(92229253269566640406818412679030119649947968911086921101413166436272241742710),
            uint256(4794743625737177589009729096405963535112090260307496056596113150248974883950),
            uint256(2364979467582775320968169226976781175064915198289420997489251241997516774551),
            uint256(83629703895530873590228379049512454567211399586869637444727602889152240751281)
        ];
        pp.g = [
            uint256(13331843606200010618799384907189640001774220689763280255686787365702813254548),
            uint256(77911691823127927681712032317834582321960584929195515936582071564861178809405),
            uint256(54982297418433140728608011012727211389863601669435709911247709360186007283586),
            uint256(4631713115856812266972995308415017556669788265290291132989457153325307269805)
        ];
        pp.h = [
            uint256(336297440385424654779928973822877265202280717266106522357474500184018192258),
            uint256(13430304776835002009147236660780457826567761074840114941948218632432411901148),
            uint256(5152316251984309431151789184458474192402750239061714675907525238063512395519),
            uint256(25080222812000304267379293936423908163260945726462622345858933413555359828434)
        ];
        pp.hInv = [
            uint256(4670108997737883483289935335164572537246010539759177071047373671643334013672),
            uint256(67278243276480884946232539298467596709779662937548631534322302828787852261289),
            uint256(15906568074560827033231654433240535443365807374897480036296147451799878175967),
            uint256(101206685324556579226837667513562561004579054877269087673861998541231720237319)
        ];
        pp.y = [
            uint256(22708432615747921031247548930729625754107999736724901847967319089267497399198),
            uint256(14309794126936984862700710231270856378251346683856110208341783788151989209384),
            uint256(110904624203736548202838710692916452598479785672010375677688678653241978338790),
            uint256(34235894648803931944916274751779635651388750415161987563189046177291283885417)
        ];
        pp.yInv = [
            uint256(73503571260704809982870281120368943087988714282468377726761143871711897274668),
            uint256(41756576516093944760953827123960734239026137586360935400766230013087671424029),
            uint256(39476005552988927142563310995466954354734516366122279974711353080107613344288),
            uint256(109417469353591888889447027708965224665885895500387636064686109877879791523989)
        ];
    }

    function testFinalizeVote()
        external
    {
        CicadaCumulativeVote.PublicParameters memory pp = _publicParameters();

        uint256[] memory talliesPlaintext = new uint256[](6);
        talliesPlaintext[0] = 186041364;
        talliesPlaintext[1] = 156376563;
        talliesPlaintext[2] = 2249922255;
        talliesPlaintext[3] = 4274438313;
        talliesPlaintext[4] = 2478444462;
        talliesPlaintext[5] = 1905799573;

        uint256[4][] memory w = new uint256[4][](6);
        w[0] = [
            uint256(11946650165173282270465389514481457689325004548099415287477126301630896414634),
            uint256(47243706422724703239921689609804659756835649489845232397401686766288658229091),
            uint256(101679537870348037175633391557888441867864431953686592541303407771366456060169),
            uint256(54531316273588768610728634204934372935601353959780375676824270810388100512344)
        ];
        w[1] = [
            uint256(37405227727235147752888631170508861953474298657140833662367971197366220439253),
            uint256(42468986306907683014918585810865649996767617086607847470491584696730440116718),
            uint256(96313522025279589513127065098261967617233427063462970079369928924053839148301),
            uint256(90662066994536362893203060439754190842584038509168310195746459957081358700836)
        ];
        w[2] = [
            uint256(36925934269126196437699311203460150430039870652909100458422609751239223862411),
            uint256(37078894042525342883700350326887487806860996099743876492511661228257432917746),
            uint256(35624373604128214374342037112647305617525886779522050022760993390903409206567),
            uint256(68018083363380143455978538575377890090019067569557107737707247834803451759510)
        ];
        w[3] = [
            uint256(14901736073829715995904857625013353398510491334132268362357920565832743797393),
            uint256(87158595893692194609505007086224476817554144437398816488501615698277780867328),
            uint256(66926238480413374178703001600934805586603456151297609082190674304251621164068),
            uint256(3311391336452400578122746285530016206969689520614745478715921995561935253182)
        ];
        w[4] = [
            uint256(26401027820802147785316952594742566607363158705268305407372284367098295502113),
            uint256(86949066719644578374529662264155139232148036835571042270160517295969647607867),
            uint256(7615097855643250745768658645263206096097062426890150440561919215055884137421),
            uint256(71318055992615144054543098961713022092610807313819512513972228471718067594686)
        ];
        w[5] = [
            uint256(40417262835466081739249848460674796063343649243283515091760207636567415161703),
            uint256(13079677455220154912550499524414978164208837108202595726290697784483939709679),
            uint256(65869483976680008142876543033417293070797938630644285108830244105942229645343),
            uint256(21499169521086659638657787314048997232039458475839994642638407726537189581628)
        ];

        LibSigmaProtocol.ProofOfExponentiation[] memory proofs = new LibSigmaProtocol.ProofOfExponentiation[](6);
        proofs[0].pi = [
            45292543232078408114325811763412021380495843871615620991285777823219719559946,            
            50316912465314978914703269946389975632640622052613619793533732061240597731185,            
            93831117509570641829561158936155810542475505788644479689237442767018148123522,            
            20664301125687446055170143975411693551553327459949344332346906619307155435958            
        ];
        proofs[0].j = 329;
        proofs[0].l = 110619960009587183530179510323163411690171169267325883928293583408161081751657;
        proofs[1].pi = [
            42600069789185424278793936021107844960713760591522338766197513961284193515897,            
            50305671354402690972061199384417943475250406628447151378279797565551384962338,            
            49370215675853451480295605333437176538541189289478400780318615931841218545097,            
            83561209821803976300194275892948754954812362118824787559617227546826958961228            
        ];
        proofs[1].j = 313;
        proofs[1].l = 86030025642767433125753746095448949113680896812070111096826810294290202126239;
        proofs[2].pi = [
            25146366932263561287148344298663425416317660926335024140365602091363780766446,            
            35676116893339882154607910899540281252630834747149542462447059000620802178457,            
            24118121514562317023846268913295828546769119816543398845052755956068672739893,            
            7371513665770860192561580013080060847029885506028420894191074889957893124172            
        ];
        proofs[2].j = 93;
        proofs[2].l = 66650299130800221038776576890132346794562361437265469819323033744510831053429;
        proofs[3].pi = [
            38314608235130781823108393159979531578738842107935886718728534075577242369842,            
            107605358503596649386536986650544749832825364293332414334577253046805175871302,            
            24772375279004858867861339217136796937316300701678421851973154216310043290264,            
            89416568478427574699869430562134071674041417354961272884796430246772698504527            
        ];
        proofs[3].j = 12;
        proofs[3].l = 103054281700440099402683016884287394392080458291122738239684084036266104493507;
        proofs[4].pi = [
            7105837354523277884920588522037165487392434280679824226281366624015172402454,            
            99281286410392427730980919519295309478119644441647150292207150832562790776186,            
            24016245966247534274961221640061728808894074679684988059628390948455396593947,            
            74662713574601787444805361746615763580994227241336133577520275924957819536152            
        ];
        proofs[4].j = 34;
        proofs[4].l = 82621475170721555036854170775623884327831157810500503963250514100592694629431;
        proofs[5].pi = [
            10780181948576662877520519389160569875418783166138408883439627276419095508368,            
            74964432352737954631762030560844684741651937814716555328306620756387756330449,            
            67170191510555350213791419672230683493510540877935962201123024139934662522958,            
            63893353093114808467375221070736745626436413823286380979474881669460174351588            
        ];
        proofs[5].j = 30;
        proofs[5].l = 78119391234591202882805900565388423440519252971891564729679051666745388956363;

        vote.finalizeVote(pp, talliesPlaintext, w, proofs);
    }
}
