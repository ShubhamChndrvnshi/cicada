// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8;

import 'forge-std/Test.sol';
import '../src/CicadaCumulativeVote.sol';
import '../src/LibUint1024.sol';
import '../src/LibSigmaProtocol.sol';


contract VoteWrapper is CicadaCumulativeVote {  
    function createVote(PublicParameters calldata pp)
        external
    {
        _createVote(
            pp,
            "test",
            10,
            0,
            0,
            6
        );

        Vote storage newVote = votes[1];
        newVote.tallies[0].u = [
            uint256(8154546191613388336338622548557533104089267572830772753231249040322051163813),
            uint256(64962287589772215254402136252241437944669854826409510620334280318059736100487),
            uint256(90855078475290741867177217392094054046494386085995076236632872594346918273790),
            uint256(19034973731843237519269756554898991267799400141661276628356485012976586513300)
        ];
        newVote.tallies[0].v = [
            uint256(25665561119820072076837043536091778124213950507536034981845778844568634989637),
            uint256(15925535203441269425713649286604543695307521251706341906633913447570962069527),
            uint256(73197580239262017091439257860295455797303018946536451318191643113421536511794),
            uint256(4818226727084075949455863827946070243279765903178923247684709843513016187657)
        ];
        newVote.tallies[1].u = [
            uint256(38145068933447885754876849805975552046641352955923452766592436424127725948781),
            uint256(1139050435530213793104148790870753141013057650067454014636155304402977661708),
            uint256(62019421357140437391031046105185070531340787458157008669265184276826892303387),
            uint256(5558914960299123345020993180725101190328044500740161469032699674100535080057)
        ];
        newVote.tallies[1].v = [
            uint256(29311500040547073811614128534100529178946408105489761581036017841725545688396),
            uint256(13858042387908556971472849528940588682638241666060755048661280876057506997359),
            uint256(89133576673539676796614193265447110827365871330763108600431367534719400995640),
            uint256(47748575005497105500713022203848555522287838978379623294997089727915229513324)
        ];
        newVote.tallies[2].u = [
            uint256(3975883964921923720736109228909879605018158728660383466681703694727639173350),
            uint256(108194231748310643746419538150489793179501762859659756785973462368128664987430),
            uint256(62937597681899867149030090796063625455908295355232298977594528555997541662337),
            uint256(49803892594817514856005962817769917321185476680800206972022108160437096413963)
        ];
        newVote.tallies[2].v = [
            uint256(9124120311299939505235019504072674251306640534369418889435132614602993929711),
            uint256(61952082072010677824629362527058214992037338420522025715811333921396758839018),
            uint256(47660716507993567061499988619756296603724820232341055137745349808278534367911),
            uint256(19210544494738210961701192220686203360709466679548889115854015425390700881265)
        ];
        newVote.tallies[3].u = [
            uint256(16404773586054268520992300346185101531169956600683294471897928498588633653825),
            uint256(85398105066725403425381637312926568620181123315791464852044313086436724975334),
            uint256(115104528155213457238476617262065310354755915700867107321514704575492276069778),
            uint256(4166598115980668309313574717959857089885482510322466165385508614722368675075)
        ];
        newVote.tallies[3].v = [
            uint256(33280727832662658260143584495020195674394637287916760013781356082399444811934),
            uint256(5099027123107239643026442183098054317008167258980725407235114296532273260630),
            uint256(109078037516064388703299325562753253593837272917159971295205052034520124273136),
            uint256(77308896555319235105214698681205171559905942609700749027524575081811404411694)
        ];
        newVote.tallies[4].u = [
            uint256(9834504138508042934567225116689622957797612904871932377575327023610412981958),
            uint256(53595348685139583104080833700621344416857926316101814335252672943870054763908),
            uint256(111495597321551078415221156595045876612324095973732294928857308704697062599162),
            uint256(48267102932896839489401260138155726775115432286154904330051327009374457862444)
        ];
        newVote.tallies[4].v = [
            uint256(37130152756901995859031015338931404734222858046410428528512719147829082105857),
            uint256(53697956382712316309095262204119607648830401543870840477340868335865385635519),
            uint256(53368718942810120559426640933565490563554839754024001756920040660555016790253),
            uint256(94698332252350511349126904412102226780943593569084751414560345411798964185305)
        ];
        newVote.tallies[5].u = [
            uint256(20442783828193289376585978130180814640203494143460704107889458763806210713360),
            uint256(51106537981671932412876406093860538608336141142366265645944323550406601503784),
            uint256(4479553005226246217449164089814095140703477085521688050948005033177531684490),
            uint256(78020606548539955484663515901361423597323623672571460683541038011966197081296)
        ];
        newVote.tallies[5].v = [
            uint256(30202341079798570987621702269623631787996037660912038302867447467204355249357),
            uint256(99968673608398835786004049942993494204714471279175489500107843735979916081916),
            uint256(8252702502326469420217377154849387677994056294575149238326046677264297953596),
            uint256(8760209664085001270592343668907911740723167046143391030649502491289457010077)
        ];
    }

    function finalizeVote(
        PublicParameters calldata pp,
        uint256[] calldata talliesPlaintext,
        uint256[4][] memory w,
        LibSigmaProtocol.ProofOfExponentiation[] calldata proofs
    )
        external
    {
        _finalizeVote(1, pp, talliesPlaintext, w, proofs);
    }
}


contract FinalizeCumulativeVoteGeneratedTest is Test {
    using LibUint1024 for *;

    VoteWrapper vote;

    function setUp() external {
        vote = new VoteWrapper();
        vote.createVote(_publicParameters());
    }

    function _publicParameters()
        private
        pure
        returns (CicadaCumulativeVote.PublicParameters memory pp)
    {
        pp.T = 87499;
        pp.N = [
            uint256(76684376039759444841217954343085513980427379466096239427691032469794219512769),
            uint256(40079223568726035961054600110029322943763488402572372475449058812227276137637),
            uint256(87960948175550788833475356845310434714815550720533096141217855935636332256419),
            uint256(75414485967850983708446544385549806864364752928403793951365275506048250272013)
        ];
        pp.g = [
            uint256(13135953638440797158883810560754522728111208264087254544411222017261595037143),
            uint256(759203550758372488986971112176312740683721910909189262899813201499077953059),
            uint256(44414968464321084679291998532230462356312185217068719566629330108163258029181),
            uint256(26636207855891358746605382397343066656484855593420107790211275836426542116915)
        ];
        pp.h = [
            uint256(16440599887777296025184929808834965931736856799014286166757951245779066057010),
            uint256(111790798234259496594516499644438439184811615715284148083744232104638826439353),
            uint256(99840339673696006949495561402104442150628550861905352244444150008526656134000),
            uint256(15627258449990149840066225308350872002436125328763249678994469638559711433334)
        ];
        pp.hInv = [
            uint256(16016046351072275367071346057986056243138045694069952951001548743652539848551),
            uint256(9615591521155651634502586684187104483039524622448726573090391331791444989514),
            uint256(102116570266798382406253140682592868546924785290829003334160798875243825601836),
            uint256(98400626286022728859965469449254668052281562430813923283175757668226684566886)
        ];
        pp.y = [
            uint256(5427669035161867053560930171635253343397192764480349707064780162522602037691),
            uint256(26867380754417505087185361028331113120326336394727488416583656244918569552705),
            uint256(3718003070615454455585686371398891653574553977736769395707922846177501692177),
            uint256(85093006986089585669679087483351082595736520303863531859010752839158452359634)
        ];
        pp.yInv = [
            uint256(21842557295035215369431092639804884730110173308648357388642963849120073486624),
            uint256(70886616436074004706018067619831352573033259164624278716758351811724339467507),
            uint256(55872749003892018292179533274399201452524170067822474760809826522722749676956),
            uint256(46153258294054856652970679663408895489901443521221699506840727201728539133348)
        ];
    }

    function testFinalizeVote()
        external
    {
        CicadaCumulativeVote.PublicParameters memory pp = _publicParameters();

        uint256[] memory talliesPlaintext = new uint256[](6);
        talliesPlaintext[0] = 865125086;
        talliesPlaintext[1] = 1560319606;
        talliesPlaintext[2] = 1052963313;
        talliesPlaintext[3] = 1923104153;
        talliesPlaintext[4] = 1868433224;
        talliesPlaintext[5] = 4013913099;

        uint256[4][] memory w = new uint256[4][](6);
        w[0] = [
            uint256(1058459396080592992460613026472310956836846669131879220954520826939258763703),
            uint256(110382581172857192760729278385188836686908136261396669910216864584386574037325),
            uint256(38724034186169146987142171163329198997467402148797721274125299533014402820110),
            uint256(109983262765310355458014833815698568757991709899276205694730267735204841329127)
        ];
        w[1] = [
            uint256(36537224337032750202671195763735337868444580315575719340744694776378599563849),
            uint256(2444549831171792009003155851707294820723927110938990023620964237065904074696),
            uint256(11684192979198712695257940253328852793479309434174536757375071225841886974144),
            uint256(50480782712048322652786162373560463906172456345464900435355157404279974715160)
        ];
        w[2] = [
            uint256(25986224955865727486696905906233382461747569954980260574981762454834508039881),
            uint256(26779061793284662210209912423678479091304982659907164906210932410812073102139),
            uint256(15599709291367360283716052007229056954240363406539332806551573383254198924958),
            uint256(38085210332024070211995131919057453291830313252392189196639728273927811674707)
        ];
        w[3] = [
            uint256(21002678160042284894480274632571059152546723700860218190641035321434470710332),
            uint256(65374696647354376796971961659757802410735268929432859000656338271118477150180),
            uint256(80291840091225458495432354166640728321960560558056991263818435318008678701446),
            uint256(95501561479301247642639450996249673601248000952758140092958610781837830686413)
        ];
        w[4] = [
            uint256(30822207553246965990622530369349274798189363544931437089698387222723243546182),
            uint256(54491830326173276592947558697873562585621148526830705663426703918016874282695),
            uint256(39025261986488958593876218976747513633563681997624012304700190847516710324677),
            uint256(86319606486560069850230790936492610090658827576675502332333398860344451354009)
        ];
        w[5] = [
            uint256(37016702175382443330122585668584861062521221416560812890020672294271719480815),
            uint256(86020551150821714514828480532625619039650721601209375935625561666498609447694),
            uint256(4158952488212285577842508928361588621634993743225860952638663876967416031234),
            uint256(78358222821271131028506108573759553661133154336639115363974713172007346365382)
        ];

        LibSigmaProtocol.ProofOfExponentiation[] memory proofs = new LibSigmaProtocol.ProofOfExponentiation[](6);
        proofs[0].pi = [
            13739871872955049441240926589015078910612477897496427471417764026539706429926,            
            94125544873179589675414931200894164641737538657307714008485063282417595483358,            
            97188047814454245108808614374919731581560778591625797648391926885460415731137,            
            4042242936410079568400407071272264571378895051638056246509583748266920572419            
        ];
        proofs[0].j = 81;
        proofs[0].l = 85100462075823328361365283494700111935195777236523228566736039962263482760149;
        proofs[1].pi = [
            19403404543339544499489163852472236124158298805492105595986551245744574779407,            
            82436188981013762643012945788089280979977916125705655156846904532648607376743,            
            19818992326994975011039159575025392282216696612606542326119855368950647994626,            
            113567579290451679813929848201853689022256992395316253287824986193178454546824            
        ];
        proofs[1].j = 81;
        proofs[1].l = 72294675352089250764813609890741996058342256714796450528435316829413883368007;
        proofs[2].pi = [
            33648356625119560184236472307562679669423042588786823533678138634790454744243,            
            83229264701322204290631844553366596314057769840592512463504773665541095277906,            
            12311951251138935439252668439064763167991160285057542664423672140219746158631,            
            73604961502817040745786331771489968328940957749176697250024826242727824741461            
        ];
        proofs[2].j = 150;
        proofs[2].l = 79565029783336178500662294607756884763713648813015006745967724966656169284963;
        proofs[3].pi = [
            36206529695849441573161742392536448836792940990120333214810087396307695365667,            
            85599747911432914411409322467129195576727231457461683851600776544251931056649,            
            101667743722952914853127777795637359010866433694182536624391352530593298044124,            
            1702694311450349765080763529905754097760916764622914585546018599737964082361            
        ];
        proofs[3].j = 100;
        proofs[3].l = 93509643992420478519742058539187100191569684171453210900070328567754054309103;
        proofs[4].pi = [
            19777920807504285115497744860730614729344135005562329159232147806123266318787,            
            33373334857116660835237450431733628297177847373844612002921725207525476459389,            
            10080677882804482106758823773627679662746510207044540804799673974378687419993,            
            14354473800312588557908503544358892547622356221947026465329662132562309302773            
        ];
        proofs[4].j = 293;
        proofs[4].l = 109310051451958214677190986108401612543433012517316937789722292458690179755373;
        proofs[5].pi = [
            26598846265587408428999316183198140419875613634836231758027743180391357847080,            
            75939171051694987440561619456950110807100600562107682364353724062204824836058,            
            64756431096908013017675701831157901492104691926792389255424127468775400666603,            
            14847706094501404614861741256994015598382433126905765233237494037772492084366            
        ];
        proofs[5].j = 84;
        proofs[5].l = 108178833229897325872448503005702294876457755582121235127719182637463675713123;

        vote.finalizeVote(pp, talliesPlaintext, w, proofs);
    }
}
